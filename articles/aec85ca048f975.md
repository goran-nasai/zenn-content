---
title: 'Next.js x microCMS でページパフォーマンス改善した記録'
emoji: '💯'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['nextjs', 'microcms']
published: false
publication_name: 'psi'
---

## 目的

https://zenn.dev/psi/articles/2140adcbd3221e

にて紹介したサイトリニューアルについて、サイト側の実装と実態について記録しておきます。

## Lighthouse 計測結果

トップページの計測結果は以下のようになりました。

Performance 68
FCP 1.3s
LCP 8.5s
TBT 130ms
CLS 0.003
SI 6.7s

旧サイトでの計測値が残っていないのが残念ですが Mobile で 10 点代でしたので、かなりの改善になっていると自負しています。

:::message
Desktop でのページパフォーマンスはよほどヒドくない限り誰も気にしていないので、Mobile を重視します。PageSpeed Insights（フィールド）は CrUX のデータが厳しすぎるので、Lighthouse 計測（ラボデータ）で算出しています。
:::

ラボデータだとしてもモバイルで 65 点を超えるサイトは少ないはずですので、日本の 5G 環境においてはほぼストレスなく閲覧できるサイトになっていると思います。

トップページだけでなく、オリジン全体で[Core Web Vitals](https://developers.google.com/search/docs/appearance/core-web-vitals?hl=ja) におけるすべての指標の Good の割合が上昇しています。

- LCP +4.31 81.48% 85.79%
- CLS +0.76 90.58% 91.34%
- FID +2.12 92.19% 94.33%

:::message
[FID については 24 年 3 月以降 INP にリプレイスされていく](https://developers.google.com/search/blog/2023/05/introducing-inp?hl=ja)ので、今後は INP を追いかけましょう。
:::

### 余談

FV の 80%以上をスライダーが占めるページにおいて、LCP で 10s を切るのは難しいのではと思っていますが、どうなんでしょうか。
少なくとも自分が手元で Lighthouse 試したことのあるサイトでは出会ったことがありません。

旧環境は WordPress x AWS。

## 構成

- コンテンツデータの管理：microCMS
- 過去のメディアデータのホスティング：Firebase Hosting
- サイト自体のホスティング：Vercel
- フロントエンド：Next.js （13 系 Pages Router）
- スタイル管理：TailwindCSS

## 工夫した点

- 画像圧縮
- microCMS 画像 API
- Vercel の強さ
- Firebase Hosting
- next/link
- next/image
- Intersection Observer
- Component 分割

### 画像圧縮

[Sqoosh](https://squoosh.app/)による事前圧縮。`public`配下にある画像（SVG 以外）は全て圧縮するように徹底。ビジュアルやパーツを作ってくれる社内のデザインチームにも事前圧縮のカルチャーがかなり浸透してきました。

### microCMS 画像 API

[imigix の Rendering API](https://docs.imgix.com/apis/rendering) を基盤として、[サイズ](https://document.microcms.io/image-api/size)や[品質](https://document.microcms.io/image-api/quality)など、読み込み時に済ませておきたい画像処理の API がひと通り揃っています。
アップロードサイズに制限かけられたらいうことなし。

### Vercel

Next.js x Vercel ってそれだけで速くないですか？
build のコールドスタートがときどき不機嫌になるのが玉に瑕。

### Firebase Hosting

数多のホスティングサービスがある中で、未だ静的コンテンツの配信においては頂点に君臨する Firebase Hosting。
安いかと言われるとそうでもないですし、実質ストレージっぽく使っているので、 Cloudflare で良かったかもしれない。

### next/link

`<Link>`にするだけでほぼ全てのことをやってくれる。
サイト内遷移であれば`<a>`を`<Link>`に変えるだけでだいぶマシになる。
ページロードと BF の挙動がイマイチ。

### next/image

レスポンシブ対応が嬉しい。
画像サイズ系は microCMS で頑張っている。
Vercel の Image Optim が高いので。

### Intersection Observer

遅延ロードの革命児。

### Component 分割

徹底できてるとは言わないが、そこそこ再利用。

## 運用面の改善

**microCMS は管理画面の UI が本当にわかりやすい**。このサイトを運用しているクライアントは特にウェブに明るいわけではないですが、WordPress のときと比べて以下の点で運用しやすいと声をいただいてます。

- 日本語で構成されている UI
- アクション後のスナックバー
- 公開状態の UI
- フィルター機能

WordPress はバージョンアップで日本語パッチがあたらなかったり、プラグインによっては日本語非対応のものもあったりで、まだまだ英語アレルギーの方にとっては扱いにくいシロモノです。
また、一覧画面で GUI からフィルター機能を使えるのは運用者として嬉しい。

### 改善点

同時ログインできないようにしてください。お願いします。
microCMS は WordPress よりさらにエンジニア向けのサービスだと思うので、なかなか難しいとは思いますが。。
少なくとも、編集画面に着地している状態で、どこかでそのコンテンツデータが更新されたらアラートは欲しい。

一括操作はより強化されることを期待。削除だけでも嬉しいですが。

一覧画面での並べ替えが手間。
